# Rate Scaling と Keyboard Level Scaling 設定ガイド

## 概要

Cranberry Synthでは、DX7互換のRate ScalingとKeyboard Level Scaling (KLS) をサポートしています。
これらの機能により、演奏するノートの高さに応じてエンベロープの速度や音量を自動的に調整できます。

---

## Rate Scaling

### 概要

Rate Scalingは、**高音ほどエンベロープが速く進行する**ようにする機能です。
自然な楽器では高音ほど減衰が速いため、この機能でリアルなサウンドを実現できます。

### パラメータ

| パラメータ | 範囲 | 説明 |
|-----------|------|------|
| `rate_scaling` | 0〜7 | Rate Scaling感度 |

- **0**: 効果なし（すべてのノートで同じエンベロープ速度）
- **7**: 最大効果（高音でエンベロープが大幅に速くなる）

### 計算式

```
x = clamp(0, 31, midinote / 3 - 7)
delta = (sensitivity × x) >> 3
```

- `delta`は各Rate (R1〜R4) に加算されます
- 結果として、高音ほどアタック・ディケイ・リリースが速くなります

### ノートとRate増分の対応表

| MIDIノート | ノート名 | x値 | RS=1 | RS=2 | RS=3 | RS=4 | RS=5 | RS=6 | RS=7 |
|-----------|---------|-----|------|------|------|------|------|------|------|
| 21 | A0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 36 | C2 | 5 | 0 | 1 | 1 | 2 | 3 | 3 | 4 |
| 48 | C3 | 9 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| 60 | C4 (Middle C) | 13 | 1 | 3 | 4 | 6 | 8 | 9 | 11 |
| 72 | C5 | 17 | 2 | 4 | 6 | 8 | 10 | 12 | 14 |
| 84 | C6 | 21 | 2 | 5 | 7 | 10 | 13 | 15 | 18 |
| 96 | C7 | 25 | 3 | 6 | 9 | 12 | 15 | 18 | 21 |
| 108 | C8 | 29 | 3 | 7 | 10 | 14 | 18 | 21 | 25 |
| 127 | G9 | 31 | 3 | 7 | 11 | 15 | 19 | 23 | 27 |

### 使用例

```cpp
OperatorPreset op;
op.rate_scaling = 3;  // 中程度の効果
```

**ピアノ系サウンド**: RS=2〜4 が適切
**ベル・パーカッション系**: RS=5〜7 で高音の減衰を速く
**パッド・ストリングス**: RS=0〜1 で均一なサステイン

---

## Keyboard Level Scaling (KLS)

### 概要

Keyboard Level Scalingは、**ブレークポイントを基準に、音の高さに応じて音量を変化させる**機能です。
高音や低音で音量を自動調整することで、より自然なサウンドを作成できます。

### パラメータ一覧

| パラメータ | 範囲 | デフォルト | 説明 |
|-----------|------|----------|------|
| `kbd_break_point` | 0〜99 | 39 | ブレークポイント（基準点） |
| `kbd_left_depth` | 0〜99 | 0 | 左側（低音）スケーリング深さ |
| `kbd_right_depth` | 0〜99 | 0 | 右側（高音）スケーリング深さ |
| `kbd_left_curve` | 0〜3 | 0 | 左側カーブタイプ |
| `kbd_right_curve` | 0〜3 | 0 | 右側カーブタイプ |

### カーブタイプ

| 値 | 名前 | 記号 | 効果 |
|----|------|-----|------|
| 0 | NegLin | -LN | 負方向・線形（離れるほど音量↓） |
| 1 | NegExp | -EX | 負方向・指数（離れるほど音量↓、急激） |
| 2 | PosExp | +EX | 正方向・指数（離れるほど音量↑、急激） |
| 3 | PosLin | +LN | 正方向・線形（離れるほど音量↑） |

### ブレークポイントとMIDIノートの対応

計算式: **MIDIノート = break_point + 21**

| kbd_break_point | MIDIノート | ノート名 | 備考 |
|-----------------|-----------|---------|------|
| 0 | 21 | A-1 | 最低設定 |
| 3 | 24 | C0 | |
| 15 | 36 | C1 | |
| 27 | 48 | C2 | |
| **39** | **60** | **C3** | **デフォルト (Middle C)** |
| 51 | 72 | C4 | |
| 63 | 84 | C5 | |
| 75 | 96 | C6 | |
| 87 | 108 | C7 | |
| 99 | 120 | C8 | 最高設定 |

---

## 関連ファイル

- [include/utils/preset.hpp](../include/utils/preset.hpp) - プリセット構造体定義
- [include/modules/envelope.hpp](../include/modules/envelope.hpp) - エンベロープクラス
- [src/modules/envelope.cpp](../src/modules/envelope.cpp) - Rate Scaling/KLS実装
